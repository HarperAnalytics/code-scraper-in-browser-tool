<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Code your own dataset!</title>
    <link rel="stylesheet" href="http://x.scraperwiki.com/vendor/style/bootstrap.min.css">
    <link rel="stylesheet" href="http://x.scraperwiki.com/vendor/style/metro.bootstrap.css">
    <style type="text/css">
body {
  padding: 20px;
}

h2 {
  margin-top: 0;
}

.muted {
  margin-right: 10px;
}

textarea {
  width: 90%;
}

    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
    <script src="https://x.scraperwiki.com/js/custard.js"></script>
  </head>
  <body>

   <form id="tw" action="#" method="POST" enctype="multipart/form-data">
      <textarea id="code" name="code" rows="15" cols="80"></textarea>
      <br>
      <input type="button" value="Run!" id="run">
      <br>
      <textarea id="console" name="console" rows="15" cols="80"></textarea>
    </form>

   <script>
      var escapeshell = function(cmd) {
        return "'"+cmd.replace(/'/g,"'\\''")+"'";
      };
      $(document).ready(function() {
        settings = readSettings()
        $('#apikey').val(settings.source.apikey)

        exec('touch ~/tool/scraper; cat ~/tool/scraper').done(function(data) {
          $('#code').val(data)
        })

        $('#run').on('click', function() {
          $('p.loading').show()
          var code = $('#code').val()
	  console.log(code)
	  if (code.substr(0,2) != "#!") {
            alert("The first line must specify the command to run, e.g. #! /usr/bin/ruby")
	    return
	  }
          var cmd = "cd ~/tool; cat >scraper.new <<ENDOFSCRAPER\n" + code + "\nENDOFSCRAPER\n"
	  cmd = cmd + "chmod a+x scraper.new; mv scraper.new scraper; ./scraper"
	  console.log(cmd)
          exec(cmd).done(function(output) {
            $('p.loading').hide()
	    $('#console').val(output)
          });
        })
      })
    </script>

  </body>
</html>

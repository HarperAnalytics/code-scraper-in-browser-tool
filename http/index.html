<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Code your own dataset!</title>
    <link rel="stylesheet" href="http://x.scraperwiki.com/vendor/style/bootstrap.min.css">
    <link rel="stylesheet" href="http://x.scraperwiki.com/vendor/style/metro.bootstrap.css">
    <style type="text/css">
	body {
        padding: 20px;
        height: 100%;
	}
	html {
        height: 100%;
	}
    #editor { 
        width: 100%;
        height: 55%;
    }
    #output { 
        width: 100%;
        height: 40%;
    }

    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
    <script src="https://x.scraperwiki.com/js/scraperwiki.js"></script>
    <script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="http://sharejs.org/channel/bcsocket.js"></script>
    <script src="http://sharejs.org/share/share.js"></script>
    <script src="http://sharejs.org/share/ace.js"></script>
  </head>
  <body>

   <div id="editor"></div>

   <form id="tw" action="#" method="POST" enctype="multipart/form-data">
      <input type="button" value="Run!" id="run">
      <br>
    </form>

   <div id="output"></div>

   <script>
    var escapeshell = function(cmd) {
      return "'"+cmd.replace(/'/g,"'\\''")+"'";
    };
    $(document).ready(function() {
        settings = scraperwiki.readSettings()
        $('#apikey').val(settings.source.apikey)

        var editor;
        scraperwiki.exec('touch ~/tool/scraper; cat ~/tool/scraper').done(function(data) {
            editor = ace.edit("editor")

            editor.setReadOnly(true);
            editor.getSession().setUseSoftTabs(true);
            editor.getSession().setMode("ace/mode/python");
            editor.setTheme("ace/theme/monokai");

            if (!document.location.hash) {
                // XXX need a better token in here. API key?
                document.location.hash = '#scraperwiki-' + scraperwiki.boxName; 
            }
            var docName = "code:" + document.location.hash.slice(1);

            sharejs.open(docName, 'text', 'http://seagrass.goatchurch.org.uk/sharejs/channel', function(error, doc) {
                if (error) {
                    console.error(error);
                    return;
                }

                if (doc.created) {
                    doc.insert(0, data);
                }

                doc.attach_ace(editor);
                editor.setReadOnly(false);
            });

            editor.clearSelection()
            editor.focus()
        })

        var output = ace.edit("output")
        output.setTheme("ace/theme/monokai")
        output.getSession().setMode("ace/mode/sh")

        $('#run').on('click', function() {
            $('p.loading').show()
            var code = editor.getValue();
            //console.log(code)
            if (code.substr(0,2) != "#!") {
                alert("The first line must specify the command to run, e.g. #! /usr/bin/ruby")
                return
            }
            output.setValue("")
            var cmd = "cd ~/tool; cat >scraper.new <<ENDOFSCRAPER\n" + code + "\nENDOFSCRAPER\n"
            cmd = cmd + "chmod a+x scraper.new; mv scraper.new scraper; ./scraper"
            //console.log(cmd)
            scraperwiki.exec(cmd).done(function(text) {
                $('p.loading').hide()
                output.setValue(text)
                output.clearSelection()
            });
        })
    })
    </script>

  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Code your own dataset!</title>
    <link rel="stylesheet" href="http://x.scraperwiki.com/vendor/style/bootstrap.min.css">
    <link rel="stylesheet" href="http://x.scraperwiki.com/vendor/style/scraperstrap.css">
    <link rel="stylesheet" href="code-in-browser.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
    <script src="https://x.scraperwiki.com/vendor/js/bootstrap.min.js"></script>
    <script src="https://x.scraperwiki.com/js/scraperwiki.js"></script>
    <script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="http://sharejs.org/channel/bcsocket.js"></script>
    <script src="http://sharejs.org/share/share.js"></script>
    <script src="http://sharejs.org/share/ace.js"></script>
  </head>
  <body>

  <div id="editor"></div>

  <form id="buttonbar" action="#" method="POST" enctype="multipart/form-data">
    <!--<input type="button" value="Run!" id="run"> -->
    <button class="btn btn-info" type="button" id="docs">Documentation</button>
    <button class="btn btn-primary" type="button" id="run">Run!</button>
    <img id="running-animation" src="running.gif" style="display: none">
  </form>

  <div id="output"></div>

    <script>

    var editor;
    var output;

    // When the "documentation" button is pressed
    var do_docs = function() {
      window.open("https://scraperwiki.com/docs/", "_blank")
    }

    // Show/hide things according to current state
    var show_status = function() {
      $(".alert").remove()
      $("#run").text("Run!").removeClass("btn-warning").addClass("btn-primary")
    }

    // When the "run" button is pressed
    var do_run = function() {
      show_status()
      $("#run").text("Running...").removeClass("btn-primary").addClass("btn-warning")

      var code = editor.getValue();
      if (code.substr(0,2) != "#!") {
          scraperwiki.alert("Specify language in the first line!", "For example, put <code>#!/usr/bin/ruby</code>, <code>#!/usr/bin/R</code> or <code>#!/usr/bin/python</code>.", false)
          return
      }
      output.setValue("")

      var cmd = "cd ~/tool; cat >scraper.new <<ENDOFSCRAPER\n" + code + "\nENDOFSCRAPER\n"
      cmd = cmd + "chmod a+x scraper.new; mv scraper.new scraper; ./scraper"
      scraperwiki.exec(cmd).done(function(text) {
          output.setValue(text)
          output.clearSelection()
          show_status()
      });
    }
    
    $(document).ready(function() {
      settings = scraperwiki.readSettings()
      $('#apikey').val(settings.source.apikey)

      scraperwiki.exec('touch ~/tool/scraper; cat ~/tool/scraper').done(function(data) {
        editor = ace.edit("editor")

        editor.setReadOnly(true);
        editor.getSession().setUseSoftTabs(true);
        editor.getSession().setMode("ace/mode/python");
        editor.setTheme("ace/theme/monokai");

        if (!document.location.hash) {
          // XXX need a better token in here. API key?
          document.location.hash = '#scraperwiki-' + scraperwiki.boxName; 
        }
        var docName = "code:" + document.location.hash.slice(1);

        sharejs.open(docName, 'text', 'http://seagrass.goatchurch.org.uk/sharejs/channel', function(error, doc) {
          if (error) {
            console.error(error);
            return;
          }

          if (doc.created) {
            doc.insert(0, data);
          }

          doc.attach_ace(editor);
          editor.setReadOnly(false);
        });

        editor.clearSelection()
        editor.focus()
      })

      output = ace.edit("output")
      output.setTheme("ace/theme/monokai")
      output.getSession().setMode("ace/mode/sh")

      $('#docs').on('click', do_docs)
      $('#run').on('click', do_run)
    })
    </script>

  </body>
</html>
